#!/usr/bin/env python

import sys
import json
import pika
import MySQLdb
from pprint import pprint

def insert_into_mysql(sql):
    db = MySQLdb.connect("localhost", "iot", "SmBYWmfaeVyspqfa","iot" )
    print sql
    cursor = db.cursor()
    cursor.execute(sql) 
    db.commit()
    db.close()

def callback(ch, method, properties, body):
    try:
        d = json.loads(body)
        pprint(d)
        sql = "INSERT INTO raw_data (gw_serial, payload, rssi, gw_timestamp) VALUES (%s, '%s', %s, '%s')"
        data = ( int(d['gw_serial']), str(d['payload']), int(d['rssi']), str(d['gw_timestamp']) )
        insert_into_mysql(sql % data) 
        ch.basic_ack(delivery_tag = method.delivery_tag)
    except Exception as e:
        print str(e)
        return

mq_host='127.0.0.1'

credentials = pika.PlainCredentials('test', 'myonetest')
connection = pika.BlockingConnection(pika.ConnectionParameters(host=mq_host, virtual_host="iot", credentials=credentials))
channel = connection.channel()
channel.basic_qos(prefetch_count=1)
channel.queue_declare(queue='hello', durable=True)
channel.basic_consume(callback, queue='hello')
channel.start_consuming()
